<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKO Player Elite Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.12); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; user-select: none; }
        
        .player-wrapper { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; cursor: pointer; }
        /* ملء الشاشة كوضع افتراضي */
        video { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        #loader { position: absolute; z-index: 100; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .spinner { width: 45px; height: 45px; border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .ui-element { transition: opacity 0.5s ease-in-out, visibility 0.5s; opacity: 1; visibility: visible; }
        .hide-ui .ui-element { opacity: 0; visibility: hidden; }

        .center-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) !important; display: flex; align-items: center; gap: 30px; z-index: 50; }
        .btn-modern { background: var(--glass); border: 1px solid var(--border); border-radius: 50%; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: transform 0.2s; outline: none; }
        .btn-side { width: 40px; height: 40px; font-size: 0.85rem; }
        .btn-main { width: 60px; height: 60px; font-size: 1.5rem; background: rgba(255,255,255,0.12); }

        /* ستايل التركيز للريموت دون تخريب الشكل */
        .btn-modern:focus, .right-tools i:focus { border-color: #fff; background: rgba(255,255,255,0.2); transform: scale(1.1); }

        .bottom-ui { position: absolute; bottom: 0; width: 100%; padding: 15px 25px 20px 25px; background: linear-gradient(transparent, rgba(0,0,0,0.85)); z-index: 40; box-sizing: border-box; }
        .progress-box { width: 100%; height: 2px; background: rgba(255,255,255,0.15); margin-bottom: 15px; }
        .progress-fill { width: 0%; height: 100%; background: #fff; transition: width 0.1s linear; }

        .controls-row { display: flex; justify-content: space-between; align-items: center; color: #fff; }
        .live-capsule { background: var(--glass); padding: 5px 15px; border-radius: 20px 20px 20px 6px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .brand { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .dot { width: 6px; height: 6px; background: #ff3b30; border-radius: 50%; box-shadow: 0 0 6px #ff3b30; }

        .right-tools { display: flex; gap: 18px; font-size: 1.1rem; align-items: center; }
        .right-tools i { cursor: pointer; opacity: 0.7; transition: 0.2s; padding: 5px; outline: none; border-radius: 4px; }

        .popup-menu {
            position: absolute; bottom: 75px; left: 25px; background: rgba(15,15,15,0.95);
            border-radius: 10px; padding: 6px; display: none; flex-direction: column; min-width: 130px; 
            z-index: 100; backdrop-filter: blur(15px); border: 1px solid var(--border);
        }
        .popup-menu div { padding: 8px 12px; cursor: pointer; color: #bbb; font-size: 0.8rem; border-radius: 6px; text-align: right; outline: none; }
        .popup-menu div:hover, .popup-menu div:focus { background: rgba(255,255,255,0.1); color: #fff; }
    </style>
</head>
<body>

<div class="player-wrapper" id="mainContainer">
    <div id="loader"><div class="spinner"></div></div>
    <video id="videoElement" autoplay muted playsinline></video>

    <div class="center-ui ui-element">
        <button class="btn-modern btn-side" id="rewindBtn" tabindex="1"><i class="fas fa-undo"></i></button>
        <button class="btn-modern btn-main" id="playBtn" tabindex="2"><i class="fas fa-pause"></i></button>
        <button class="btn-modern btn-side" id="forwardBtn" tabindex="3"><i class="fas fa-redo"></i></button>
    </div>

    <div id="qualityMenu" class="popup-menu ui-element"></div>
    <div id="audioMenu" class="popup-menu ui-element"></div>
    <div id="aspectMenu" class="popup-menu ui-element"></div>

    <div class="bottom-ui ui-element">
        <div class="progress-box" id="pTrack"><div class="progress-fill" id="pFill"></div></div>
        <div class="controls-row">
            <div class="live-capsule"><div class="brand">AKO <div class="dot"></div></div></div>
            <div class="right-tools">
                <i class="fas fa-mobile-screen-button" id="rotateBtn" tabindex="4"></i>
                <i class="fas fa-language" id="audioBtn" tabindex="5"></i>
                <i class="fas fa-cog" id="setBtn" tabindex="6"></i>
                <i class="fas fa-expand" id="fsBtn" tabindex="7"></i>
                <i class="fas fa-volume-mute" id="volBtn" tabindex="8"></i>
            </div>
        </div>
    </div>
</div>

<script>
    const manifestUri = 'https://sps1.starzplayarabia.com/out/v1/eee188845e9543699fd24e5a9890c6e2/index.mpd';
    const clearKeys = { 'b253c726c24c7c94a3ddf9b1907e2c76': '097963d6ad73c3d712a104981de0ed42' };

    async function init() {
        const video = document.getElementById('videoElement');
        const player = new shaka.Player(video);
        const container = document.getElementById('mainContainer');
        const loader = document.getElementById('loader');
        let timer;

        player.configure({ drm: { clearKeys: clearKeys } });

        video.addEventListener('timeupdate', () => {
            if (video.currentTime > 0) loader.style.display = 'none';
            document.getElementById('pFill').style.width = (video.currentTime / video.duration) * 100 + '%';
        });

        const resetTimer = () => {
            clearTimeout(timer);
            if (!video.paused && !container.classList.contains('hide-ui')) {
                timer = setTimeout(() => container.classList.add('hide-ui'), 4000);
            }
        };

        const closeMenus = () => document.querySelectorAll('.popup-menu').forEach(m => m.style.display = 'none');

        // أحداث الأزرار (إصلاح النقر)
        const action = (e, callback) => {
            if(e) { e.preventDefault(); e.stopPropagation(); }
            callback();
            resetTimer();
        };

        document.getElementById('playBtn').onclick = (e) => action(e, () => video.paused ? video.play() : video.pause());
        document.getElementById('rewindBtn').onclick = (e) => action(e, () => video.currentTime -= 10);
        document.getElementById('forwardBtn').onclick = (e) => action(e, () => video.currentTime += 10);
        document.getElementById('volBtn').onclick = (e) => action(e, () => {
            video.muted = !video.muted;
            document.getElementById('volBtn').className = video.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
        });

        video.onplay = () => document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>';
        video.onpause = () => document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';

        container.onclick = () => {
            if (video.muted) { video.muted = false; document.getElementById('volBtn').className = 'fas fa-volume-up'; }
            if (container.classList.contains('hide-ui')) { container.classList.remove('hide-ui'); resetTimer(); }
            else { container.classList.add('hide-ui'); closeMenus(); }
        };

        // إدارة القوائم
        const setupMenu = (btnId, menuId, title, itemsFn, selectFn) => {
            document.getElementById(btnId).onclick = (e) => action(e, () => {
                const menu = document.getElementById(menuId);
                const isVisible = menu.style.display === 'flex';
                closeMenus();
                if (!isVisible) {
                    menu.style.display = 'flex';
                    menu.innerHTML = `<div style="color:#555;font-size:0.6rem;padding:5px;">${title}</div>`;
                    itemsFn().forEach((item, i) => {
                        const div = document.createElement('div');
                        div.innerText = item.label;
                        div.tabIndex = 10 + i;
                        div.onclick = () => { selectFn(item.val); closeMenus(); };
                        menu.appendChild(div);
                    });
                }
            });
        };

        setupMenu('fsBtn', 'aspectMenu', 'عرض', 
            () => [{label:'ملء الشاشة', val:'cover'}, {label:'الأصلي', val:'contain'}, {label:'تمدد', val:'fill'}],
            (v) => video.style.objectFit = v
        );

        setupMenu('audioBtn', 'audioMenu', 'اللغة', 
            () => [...new Set(player.getVariantTracks().map(t => t.language))].map(l => ({label: l=='ar'?'العربية':'English', val: l})),
            (l) => player.selectAudioLanguage(l)
        );

        setupMenu('setBtn', 'qualityMenu', 'الجودة',
            () => player.getVariantTracks().sort((a,b)=>b.height-a.height).filter((v,i,a)=>a.findIndex(t=>t.height===v.height)===i).map(t => ({label: t.height+'p', val: t})),
            (t) => { player.configure({abr:{enabled:false}}); player.selectVariantTrack(t, true); }
        );

        // دعم الريموت (بدون تغيير الشكل)
        window.addEventListener('keydown', (e) => {
            if (container.classList.contains('hide-ui')) { container.classList.remove('hide-ui'); resetTimer(); return; }
            const focusable = document.querySelectorAll('button, i[tabindex], .popup-menu div[tabindex]');
            let index = Array.from(focusable).indexOf(document.activeElement);
            if (e.key === 'ArrowRight') { index = Math.max(0, index - 1); focusable[index]?.focus(); }
            if (e.key === 'ArrowLeft') { index = Math.min(focusable.length - 1, index + 1); focusable[index]?.focus(); }
            if (e.key === 'Enter' && document.activeElement) document.activeElement.click();
            resetTimer();
        });

        try { await player.load(manifestUri); video.play(); } catch (e) {}
    }

    document.addEventListener('DOMContentLoaded', () => { shaka.polyfill.installAll(); init(); });
</script>
</body>
</html>
