<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>جدول مباريات اليوم</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
<style>
    body {
        font-family: 'Cairo', sans-serif;
        background: black;
        color: white;
        padding: 20px;
        direction: rtl;
        padding-bottom: 80px;
    }

    .match-row {
        background: black;
        border: 1px solid white;
        border-radius: 8px;
        margin-bottom: 15px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .teams-time {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }

    .team {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        flex: 1;
    }

    .team img, .team .protv-logo {
        width: 60px;
        height: 60px;
        object-fit: contain;
        margin-bottom: 5px;
    }

    .protv-logo {
        border: 2px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 12px;
    }

    .team-name {
        font-size: 8px;
        font-weight: 700;
    }

    .match-time {
        display: flex;
        justify-content: center;
        align-items: center;
        flex: 1;
    }

    .countdown-circle {
        position: relative;
        width: 60px;
        height: 60px;
        border-radius: 50%;
    }

    .countdown-circle svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }

    .countdown-circle circle {
        fill: none;
        stroke-width: 5;
        r: 28;
        cx: 30;
        cy: 30;
    }

    .countdown-circle .bg {
        stroke: white;
        opacity: 0.3;
    }

    .countdown-circle .progress {
        stroke: red;
        stroke-linecap: round;
        stroke-dasharray: 175.84;
        stroke-dashoffset: 175.84;
        transition: stroke-dashoffset 0.5s linear;
    }

    .countdown-circle .time-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 7px;
        display: flex;
        flex-direction: column;
        align-items: center;
        line-height: 1.2;
    }

    .countdown-circle .penalties {
        font-size: 10px;
        opacity: 0.7;
    }

    .countdown-circle .timer-small-text {
        font-size: 12px;
        font-weight: normal;
        display: block;
        line-height: 1;
        margin-top: 2px;
    }
    
    .match-score-finished {
        background-color: red;
        border: 1px solid white;
        border-radius: 5px;
        padding: 10px 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-width: 60px;
        height: 60px;
        box-sizing: border-box;
    }

    .match-score-finished .main-score {
        font-size: 9px;
        font-weight: bold;
        color: white;
    }

    .match-score-finished .penalties-score {
        font-size: 6px;
        color: white;
        margin-top: 2px;
    }

    .channel-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
        width: 100%;
        justify-content: center;
        align-items: center;
    }

    .watch-btn-container {
        position: relative;
        width: 100%;
        margin: 0 auto;
        max-width: 100%;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .watch-btn {
        background: linear-gradient(to right, #FF0000, #CC0000);
        border: none;
        color: white;
        border-radius: 6px;
        padding: 10px 15px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        width: 100%;
        text-align: center;
        font-family: 'Cairo', sans-serif;
        display: block;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .finished-btn {
        background: red;
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: 700;
        cursor: default;
        text-align: center;
        width: 100%;
    }

    .not-started-btn {
        background-color: #333;
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: 700;
        cursor: default;
        text-align: center;
        width: 100%;
    }

    .edit-icon {
        display: none;
    }

    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    #progress-bar-container {
        width: 80%;
        max-width: 600px;
        height: 10px;
        background-color: #333;
        border-radius: 5px;
        margin: 10px auto;
        overflow: hidden;
        display: none;
    }

    #progress-bar {
        width: 0%;
        height: 100%;
        background-color: red;
        transition: width 0.3s ease;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.8);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #1a1a1a;
        margin: 5% auto;
        padding: 20px;
        padding-top: 40px; 
        border: 1px solid #888;
        width: 90%;
        max-width: 300px;
        border-radius: 10px;
        position: relative;
    }

    .modal-title {
        display: none;
    }

    .close-btn {
        color: white;
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 28px;
        font-weight: bold;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: #ff0000;
        text-decoration: none;
        cursor: pointer;
    }

    .server-list {
        list-style-type: none;
        padding: 0;
        margin-top: 20px;
    }

    .server-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #2a2a2a;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .server-item span {
        flex: 1;
        text-align: right;
    }

    .live-server-btn {
        background: #FF0000;
        border: none;
        color: white;
        border-radius: 6px;
        padding: 10px 15px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        width: 100%;
        text-align: center;
        font-family: 'Cairo', sans-serif;
        display: block;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }
    .external-player-btn {
        background: #FF0000;
        border: none;
        color: white;
        border-radius: 6px;
        padding: 10px 15px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        width: 100%;
        text-align: center;
        font-family: 'Cairo', sans-serif;
        display: block;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .watch-btn:focus,
    .live-server-btn:focus,
    .load-btn:focus {
        outline: none;
    }

    .button-container-wrapper {
        max-width: 700px;
        margin: auto;
    }

    .button-container {
        display: flex;
        justify-content: center;
        gap: 0;
        margin: 20px 0;
        border-radius: 5px;
        overflow: hidden;
        background-color: #333;
        width: 100%;
    }

    .load-btn {
        font-family: 'Cairo', sans-serif;
        background-color: transparent;
        color: white;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
        flex-grow: 1;
        font-weight: bold;
        transition: background-color 0.3s ease;
    }

    .load-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .load-btn:first-child {
        border-radius: 5px 0 0 5px;
    }

    .load-btn:last-child {
        border-radius: 0 5px 5px 0;
    }

    .load-btn.active {
        background-color: #FF0000;
    }

    .search-refresh-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }

    .search-box {
        display: flex;
        align-items: center;
        flex-grow: 1;
        padding: 10px;
        border-radius: 20px;
        background-color: black;
        border: 1px solid white;
    }

    .search-box i {
        color: white;
        font-size: 16px;
        margin-left: 10px;
    }

    .search-input-field {
        flex-grow: 1;
        border: none;
        background: transparent;
        color: white;
        font-family: 'Cairo', sans-serif;
        font-size: 16px;
        text-align: right;
        min-width: 0;
    }

    .search-input-field:focus {
        outline: none;
    }

    .refresh-btn {
        padding: 10px 15px;
        border-radius: 5px;
        border: none;
        background-color: #333;
        color: white;
        font-family: 'Cairo', sans-serif;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .refresh-btn:hover {
        background-color: #555;
    }
    
    .error-message {
        text-align: center;
        color: white;
        font-size: 18px;
        margin-top: 20px;
    }
    
    .retry-btn {
        background-color: #555;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
        display: block;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        font-family: 'Cairo', sans-serif;
    }
    
    .external-player-modal-content {
        background-color: #1a1a1a;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 300px;
        border-radius: 10px;
        text-align: center;
        position: relative;
    }

    .external-player-modal-content .close-btn {
        top: 10px;
        right: 10px;
        left: unset;
    }

    .external-player-modal-content p {
        margin-bottom: 20px;
        font-size: 16px;
    }

    .modal-buttons-container {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        gap: 10px;
        width: 100%;
    }

    .download-player-btn {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: 700;
        text-decoration: none;
        flex-grow: 1;
        text-align: center;
    }
    
    .watch-external-btn {
        background-color: red;
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: 700;
        text-decoration: none;
        flex-grow: 1;
        text-align: center;
    }

    #bottom-navbar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background-color: black;
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid white;
        z-index: 200;
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: white;
        font-size: 10px;
        font-weight: 700;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .nav-item i {
        font-size: 20px;
        margin-bottom: 4px;
    }
</style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

<div class="search-refresh-container">
    <button id="refresh-btn" class="refresh-btn"><i class="fas fa-sync-alt"></i></button>
    <div class="search-box">
        <input type="text" id="search-input" class="search-input-field" placeholder="ابحث عن مباراة...">
        <i class="fas fa-search"></i>
    </div>
</div>

<div id="loading" class="loading-spinner"></div>
<div id="progress-bar-container">
    <div id="progress-bar"></div>
</div>
<div id="matches-container" style="max-width:700px; margin:auto;"></div>

<div id="bottom-navbar">
    <a href="go:jdol" class="nav-item">
        <i class="fas fa-futbol"></i>
        <span>جدول المباريات</span>
    </a>
    <a href="go:VOD" class="nav-item">
        <i class="fas fa-film"></i>
        <span>VOD</span>
    </a>
    <a href="go:HOME" class="nav-item">
        <i class="fas fa-tv"></i>
        <span>تلفاز</span>
    </a>
    <a href="go:youtube" class="nav-item">
        <i class="fab fa-youtube"></i>
        <span>يوتيوب</span>
    </a>
    <a href="go:telegram" class="nav-item">
        <i class="fab fa-telegram"></i>
        <span>تلغرام</span>
    </a>
</div>

<div id="liveServersModal" class="modal">
    <div class="modal-content">
        <span id="liveServersModalCloseBtn" class="close-btn">×</span>
        <h2 class="modal-title"></h2>
        <ul id="liveServerList" class="server-list">
        </ul>
    </div>
</div>

<div id="externalPlayerModal" class="modal">
    <div class="external-player-modal-content">
        <span id="externalPlayerModalCloseBtn" class="close-btn">×</span>
        <p>هذا السيرفر يحتاج لمشغل خارجي</p>
        <div class="modal-buttons-container">
            <a id="downloadPlayerBtn" class="download-player-btn" href="go:player">تحميل المشغل</a>
            <a id="watchExternalBtn" class="watch-external-btn" href="#">شاهد</a>
        </div>
    </div>
</div>

<script>
    const teamLogos = {
  "Al-Nassr FC": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/5/5a/Al-Nassr_FC_logo.svg/1200px-Al-Nassr_FC_logo.svg.png", "keywords": ["النصر"] },
  "Al-Hilal SFC": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/c/c1/Al-Hilal_SFC_logo.svg/1200px-Al-Hilal_SFC_logo.svg.png", "keywords": ["الهلال"] },
  "Al-Ahli Saudi FC": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/d/d4/Al_Ahli_Saudi_FC_logo.svg/1200px-Al_Ahli_Saudi_FC_logo.svg.png", "keywords": ["الأهلي"] },
  "Al-Ittihad Club": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/8/89/Ittihad_FC_logo.svg/1200px-Ittihad_FC_logo.svg.png", "keywords": ["الاتحاد"] },
  "Real Madrid CF": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/1200px-Real_Madrid_CF.svg.png", "keywords": ["ريال مدريد", "Real Madrid"] },
  "FC Barcelona": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/4/47/FC_Barcelona_%28crest%29.svg/1200px-FC_Barcelona_%28crest%29.svg.png", "keywords": ["برشلونة", "Barcelona"] },
  "Liverpool FC": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/0/0c/Liverpool_FC.svg/1200px-Liverpool_FC.svg.png", "keywords": ["ليفربول", "Liverpool"] },
  "Manchester City FC": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/e/e1/Manchester_City_F.C._logo.svg/1200px-Manchester_City_F.C._logo.svg.png", "keywords": ["مانشستر سيتي", "Man City"] },
  "Al-Ahly SC (Egypt)": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/5/5b/Al_Ahly_SC_logo.svg/1200px-Al_Ahly_SC_logo.svg.png", "keywords": ["الأهلي المصري"] },
  "Zamalek SC": { "url": "https://upload.wikimedia.org/wikipedia/en/thumb/d/d1/Zamalek_SC.svg/1200px-Zamalek_SC.svg.png", "keywords": ["الزمالك"] },
  "بورنموث": { "url": "https://upload.wikimedia.org/wikipedia/ar/e/e5/AFC_Bournemouth_%282013%29.svg", "keywords": ["بورنموث"] },
  "جيرونا": { "url": "https://upload.wikimedia.org/wikipedia/ar/b/b7/Girona_FC_%282022%29.svg", "keywords": ["جيرونا"] },
  "ريال مدريد": { "url": "https://upload.wikimedia.org/wikipedia/sco/5/56/Real_Madrid_CF.svg", "keywords": ["ريال مدريد"] },
  "برشلونة": { "url": "https://upload.wikimedia.org/wikipedia/sco/4/47/FC_Barcelona_%28crest%29.svg", "keywords": ["برشلونة"] },
  "أتليتكو مدريد": { "url": "https://upload.wikimedia.org/wikipedia/ar/f/f4/Atletico_Madrid_2017_logo.svg", "keywords": ["أتليتكو مدريد"] },
  "فالنسيا": { "url": "https://upload.wikimedia.org/wikipedia/ar/d/d3/Valencia_CF.svg", "keywords": ["فالنسيا"] },
  "فياريال": { "url": "https://upload.wikimedia.org/wikipedia/ar/7/70/Villarreal_CF_logo.svg", "keywords": ["فياريال"] },
  "تيرول": { "url": "https://upload.wikimedia.org/wikipedia/fr/5/5b/WSG_Swarovski_Tirol_%28logo%29.svg", "keywords": ["تيرول"] }
};

    const matchLinks = [
    {
        "name": "BEIN SPORTS 1",
        "url": "go:bein1s1",
        "keywords": [
            "ليفربول",
            "مانشستر سيتي",
            "مانشستر يونايتد",
            "آرسنال",
            "تشيلسي",
            "نيوكاسل يونايتد",
            "فولهام",
            "توتنهام هوتسبير"
        ],
        "serverType": "internal"
    },
    {
        "name": "BEIN SPORTS 1",
        "url": "go:bein1s2",
        "keywords": [
            "ليفربول",
            "مانشستر سيتي",
            "مانشستر يونايتد",
            "تشيلسي",
            "آرسنال",
            "نيوكاسل",
            "فولهام",
            "توتنهام هوتسبير"
        ],
        "serverType": "internal"
    },
    {
        "name": "مشغل خارجي",
        "url": "go:C",
        "keywords": [
            "ليفربول",
            "مانشستر سيتي"
        ],
        "serverType": "external"
    },
    {
        "name": "BEIN SPORTS 3",
        "url": "go:bein3s1",
        "keywords": [
            "برشلونة"
        ],
        "serverType": "internal"
    }
];

    const matchesContainer = document.getElementById('matches-container');
    const loadingSpinner = document.getElementById('loading');
    const progressBarContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const liveServersModal = document.getElementById('liveServersModal');
    const liveServersModalCloseBtn = document.getElementById('liveServersModalCloseBtn');
    const liveServerList = document.getElementById('liveServerList');
    const searchInput = document.getElementById('search-input');
    const refreshBtn = document.getElementById('refresh-btn');
    let allMatches = [];
    let progressInterval;

    const externalPlayerModal = document.getElementById('externalPlayerModal');
    const externalPlayerModalCloseBtn = document.getElementById('externalPlayerModalCloseBtn');
    const watchExternalBtn = document.getElementById('watchExternalBtn');

    function renderLiveServers(homeTeam, awayTeam) {
        liveServerList.innerHTML = '';
        const matchingServerLinks = matchLinks.filter(linkData => {
            const allKeywords = [homeTeam, awayTeam];
            return linkData.keywords.some(keyword => {
                return allKeywords.some(teamName => teamName.includes(keyword) || keyword.includes(teamName));
            });
        });

        if (matchingServerLinks.length === 0) {
            liveServerList.innerHTML = '<p style="text-align: center;">لا يوجد سيرفرات متاحة لهذه المباراة حاليًا.</p>';
            return;
        }

        matchingServerLinks.forEach((linkData) => {
            const li = document.createElement('li');
            li.className = 'server-item';
            
            const liveBtn = document.createElement('a');
            liveBtn.className = 'live-server-btn';
            liveBtn.textContent = linkData.name;

            if (linkData.serverType === "external") {
                liveBtn.onclick = (e) => {
                    e.preventDefault();
                    watchExternalBtn.href = linkData.url;
                    liveServersModal.style.display = 'none';
                    externalPlayerModal.style.display = 'block';
                };
            } else {
                liveBtn.href = linkData.url;
                liveBtn.target = '_blank';
            }
            
            li.appendChild(liveBtn);
            liveServerList.appendChild(li);
        });
    }

    function loadMatches(url) {
        const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
        matchesContainer.innerHTML = '';
        
        loadingSpinner.style.display = 'block';
        progressBarContainer.style.display = 'block';
        progressBar.style.width = '0%';
        
        let progress = 0;
        clearInterval(progressInterval);
        progressInterval = setInterval(() => {
            if (progress < 95) {
                progress += Math.floor(Math.random() * 5) + 1;
                progressBar.style.width = `${progress}%`;
            } else {
                clearInterval(progressInterval);
            }
        }, 300);

        fetch(proxyUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const html = data.contents;
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const matches = doc.querySelectorAll('li.single_match');
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    loadingSpinner.style.display = 'none';
                    progressBarContainer.style.display = 'none';
                }, 500);
                
                if (matches.length === 0) {
                     showErrorScreen();
                     return;
                }

                allMatches = [];
                matches.forEach(match => allMatches.push(match));

                renderMatches(allMatches);
            })
            .catch(err => {
                console.error(err);
                clearInterval(progressInterval);
                loadingSpinner.style.display = 'none';
                progressBarContainer.style.display = 'none';
                showErrorScreen();
            });
    }

    function showErrorScreen() {
        matchesContainer.innerHTML = `
            <div class="error-message">
                <p>الإنترنت ضعيف</p>
                <button class="retry-btn" id="retry-btn">أعد المحاولة</button>
            </div>
        `;
        document.getElementById('retry-btn').addEventListener('click', () => {
            loadMatches('https://jdwel.com/today/');
        });
    }

    function createTeamLogo(imgUrl, teamName, isExactMatch) {
        if (!isExactMatch || imgUrl.includes('placeholder.com')) {
            const div = document.createElement('div');
            div.className = 'protv-logo';
            div.textContent = 'PRO TV';
            return div;
        } else {
            const img = document.createElement('img');
            img.src = imgUrl;
            img.alt = 'شعار ' + teamName;
            img.className = 'team-logo';
            return img;
        }
    }

    function abbreviateTeamName(teamName) {
        const parts = teamName.split(' ');
        if (parts.length > 1) {
            return parts && parts.length > 0 ? parts.slice(0, 1).join('').charAt(0) + '.' + parts.slice(-1).join('') : teamName;
        }
        return teamName;
    }
    
    // New function to update a single timer
    function updateSingleMatchTimer(matchRow) {
        const countdownCircle = matchRow.querySelector('.countdown-circle');
        const timeText = countdownCircle?.querySelector('.time-text');
        
        if (!timeText) return;

        const radius = 28;
        const circumference = 2 * Math.PI * radius;
        const firstHalfEnd = 45;
        const breakDuration = 15;
        const totalMatchDuration = 90;
        const countdownStartMinutes = 30;
        
        const progress = countdownCircle.querySelector('.progress');
        if (progress) {
            progress.style.strokeDasharray = circumference;
            progress.style.strokeDashoffset = circumference;
        }
        
        setInterval(() => {
            const now = luxon.DateTime.local();
            const matchTimestamp = timeText.getAttribute('data-match-timestamp');
            const matchDate = matchTimestamp ? luxon.DateTime.fromMillis(parseInt(matchTimestamp) * 1000) : null;
            
            if (!matchDate) {
                timeText.textContent = timeText.getAttribute('data-time');
                if (countdownCircle) countdownCircle.style.display = 'block';
                return;
            }
            
            const timeDifferenceInSeconds = now.diff(matchDate, 'seconds').seconds;
            const timeUntilMatchInSeconds = matchDate.diff(now, 'seconds').seconds;
            let minutesElapsed;
            
            const matchEndTimestamp = matchDate.plus({ hours: 2 }).toMillis() / 1000;
            
            if (now.toMillis() / 1000 > matchEndTimestamp) {
                countdownCircle.style.display = 'none';
            } else if (timeUntilMatchInSeconds > 0 && timeUntilMatchInSeconds <= countdownStartMinutes * 60) {
                const remainingDuration = luxon.Duration.fromObject({ seconds: timeUntilMatchInSeconds }).rescale();
                const formattedTime = remainingDuration.setLocale('en').toFormat('h:mm:ss');
                
                timeText.innerHTML = formattedTime;
                timeText.style.fontSize = '12px';
                
                const percent = 1 - (timeUntilMatchInSeconds / (countdownStartMinutes * 60));
                if(progress) progress.style.stroke = "green";
                if(progress) progress.style.strokeDashoffset = circumference * (1 - percent);
            } else if (timeDifferenceInSeconds >= 0) {
                if(progress) progress.style.stroke = "red";
                if(timeText) timeText.style.fontSize = '14px';

                if (timeDifferenceInSeconds <= firstHalfEnd * 60) {
                    minutesElapsed = Math.floor(timeDifferenceInSeconds / 60);
                    timeText.textContent = `${minutesElapsed}'`;
                    const percent = minutesElapsed / totalMatchDuration;
                    if(progress) progress.style.strokeDashoffset = circumference * (1 - percent);
                } else if (timeDifferenceInSeconds <= (firstHalfEnd + breakDuration) * 60) {
                    timeText.textContent = 'Break';
                    const percent = firstHalfEnd / totalMatchDuration;
                    if(progress) progress.style.strokeDashoffset = circumference * (1 - percent);
                } else if (timeDifferenceInSeconds <= (totalMatchDuration + breakDuration) * 60) {
                    const secondHalfTime = timeDifferenceInSeconds - (firstHalfEnd + breakDuration) * 60;
                    minutesElapsed = Math.floor(secondHalfTime / 60) + firstHalfEnd;
                    
                    if (minutesElapsed >= 90) {
                         timeText.textContent = "90+'";
                         minutesElapsed = 90;
                    } else {
                         timeText.textContent = `${minutesElapsed}'`;
                    }
                    const percent = minutesElapsed / totalMatchDuration;
                    if(progress) progress.style.strokeDashoffset = circumference * (1 - percent);
                }
            } else {
                timeText.textContent = timeText.getAttribute('data-time');
                if(progress) progress.style.stroke = "red";
                if(progress) progress.style.strokeDashoffset = circumference;
                if(timeText) timeText.style.fontSize = '14px';
            }
        }, 1000);
    }

    function renderMatches(matches) {
        matchesContainer.innerHTML = '';
        if (matches.length === 0) {
            matchesContainer.innerHTML = '<p style="text-align:center;">لم يتم العثور على مباريات</p>';
            return;
        }

        const importantMatches = [];
        const otherMatches = [];

        matches.forEach(match => {
            const homeTeam = match.querySelector('.team.hometeam .the_team')?.innerText.trim() || 'فريق';
            const awayTeam = match.querySelector('.team.awayteam .the_team')?.innerText.trim() || 'فريق';
            const importantTeams = ["الهلال", "النصر", "ريال مدريد", "برشلونة", "ليفربول", "مانشستر سيتي"];
            const isImportant = importantTeams.some(teamName => homeTeam.includes(teamName) || awayTeam.includes(teamName));
            if (isImportant) {
                importantMatches.push(match);
            } else {
                otherMatches.push(match);
            }
        });

        const sortedMatches = importantMatches.concat(otherMatches);

        function displayMatchesGradually(matchList) {
            let index = 0;
            function displayNextMatch() {
                if (index < matchList.length) {
                    const match = matchList[index];
                    const homeTeam = match.querySelector('.team.hometeam .the_team')?.innerText.trim() || 'فريق';
                    const awayTeam = match.querySelector('.team.awayteam .the_team')?.innerText.trim() || 'فريق';
                    let matchScoreText = match.querySelector('.score')?.innerText.trim() ||
                                         match.querySelector('.match_score')?.innerText.trim() ||
                                         null;
                    
                    let mainScore = matchScoreText;
                    let penaltiesScore = null;
                    if (matchScoreText && matchScoreText.includes('(')) {
                        const scoreParts = matchScoreText.split('(');
                        mainScore = scoreParts[0].trim();
                        penaltiesScore = scoreParts[1].replace(')', '').trim();
                    }

                    let homeLogo = 'https://via.placeholder.com/60';
                    let awayLogo = 'https://via.placeholder.com/60';
                    let isHomeLogoExactMatch = false;
                    let isAwayLogoExactMatch = false;

                    for (const key in teamLogos) {
                        if (teamLogos[key].keywords.some(kw => homeTeam.includes(kw))) {
                            homeLogo = teamLogos[key].url;
                            isHomeLogoExactMatch = true;
                        }
                        if (teamLogos[key].keywords.some(kw => awayTeam.includes(kw))) {
                            awayLogo = teamLogos[key].url;
                            isAwayLogoExactMatch = true;
                        }
                    }

                    const matchTimeElement = match.querySelector('.match_time .the_otime');
                    const matchTime = matchTimeElement?.innerText.trim() || '-';
                    const timeOnly = matchTime.match(/\d{1,2}:\d{2}/) ? matchTime.match(/\d{1,2}:\d{2}/)[0] : matchTime;

                    let matchDateObject = null;
                    if (timeOnly !== '-') {
                        const now = luxon.DateTime.local();
                        const [hours, minutes] = timeOnly.split(':').map(Number);
                        
                        let matchDate = now;
                        matchDateObject = matchDate.set({ hour: hours, minute: minutes, second: 0, millisecond: 0 });
                    }

                    const matchTimestamp = matchDateObject ? matchDateObject.toMillis() / 1000 : '';
                    
                    const isFinished = (matchDateObject && luxon.DateTime.local() > matchDateObject.plus({ hours: 2 }));
                    const isLive = !isFinished && matchDateObject && luxon.DateTime.local() >= matchDateObject.minus({ minutes: 30 }) && luxon.DateTime.local() <= matchDateObject.plus({ hours: 2 });
                    const isNotStartedYet = !isFinished && !isLive;
                    
                    const matchRow = document.createElement('div');
                    matchRow.className = 'match-row';
                    matchRow.style.opacity = '0';
                    matchRow.style.transition = 'opacity 0.5s ease-in-out';
                    
                    matchRow.innerHTML = `
                        <div class="teams-time">
                          <div class="team" id="home-team-container-${index}"></div>
                          <div class="match-time" id="match-time-container-${index}"></div>
                          <div class="team" id="away-team-container-${index}"></div>
                        </div>
                        <div class="channel-container" id="channel-container-${index}"></div>
                    `;
                    
                    matchesContainer.appendChild(matchRow);
                    
                    const homeContainer = matchRow.querySelector(`#home-team-container-${index}`);
                    homeContainer.appendChild(createTeamLogo(homeLogo, homeTeam, isHomeLogoExactMatch));
                    const homeNameDiv = document.createElement('div');
                    homeNameDiv.className = 'team-name';
                    homeNameDiv.textContent = abbreviateTeamName(homeTeam);
                    homeContainer.appendChild(homeNameDiv);

                    const awayContainer = matchRow.querySelector(`#away-team-container-${index}`);
                    awayContainer.appendChild(createTeamLogo(awayLogo, awayTeam, isAwayLogoExactMatch));
                    const awayNameDiv = document.createElement('div');
                    awayNameDiv.className = 'team-name';
                    awayNameDiv.textContent = abbreviateTeamName(awayTeam);
                    awayContainer.appendChild(awayNameDiv);

                    const matchTimeContainer = matchRow.querySelector(`#match-time-container-${index}`);

                    if (isFinished && mainScore) {
                        const finishedScoreDiv = document.createElement('div');
                        finishedScoreDiv.className = 'match-score-finished';
                        const mainScoreSpan = document.createElement('span');
                        mainScoreSpan.className = 'main-score';
                        mainScoreSpan.textContent = mainScore;
                        finishedScoreDiv.appendChild(mainScoreSpan);
                        if (penaltiesScore) {
                            const penaltiesSpan = document.createElement('span');
                            penaltiesSpan.className = 'penalties-score';
                            penaltiesSpan.textContent = `(${penaltiesScore})`;
                            finishedScoreDiv.appendChild(penaltiesSpan);
                        }
                        matchTimeContainer.appendChild(finishedScoreDiv);
                    } else {
                        const countdownCircle = document.createElement('div');
                        countdownCircle.className = 'countdown-circle';
                        countdownCircle.innerHTML = `
                            <svg>
                                <circle class="bg"></circle>
                                <circle class="progress"></circle>
                            </svg>
                            <div class="time-text" data-time="${timeOnly}"
                                                 data-match-timestamp="${matchTimestamp || ''}"
                                                 data-score="${mainScore || ''}"
                                                 data-penalties="${penaltiesScore || ''}">
                                ${timeOnly}
                            </div>
                        `;
                        matchTimeContainer.appendChild(countdownCircle);
                        updateSingleMatchTimer(matchRow);
                    }


                    const channelContainer = matchRow.querySelector(`#channel-container-${index}`);
                    const watchBtnContainer = document.createElement('div');
                    watchBtnContainer.className = 'watch-btn-container';

                    const watchBtn = document.createElement('a');
                    watchBtn.href = '#';
                    watchBtn.className = 'watch-btn';
                    watchBtn.textContent = 'شاهد المباراة';

                    const finishedBtn = document.createElement('div');
                    finishedBtn.className = 'finished-btn';
                    finishedBtn.textContent = 'انتهت';

                    const notStartedBtn = document.createElement('div');
                    notStartedBtn.className = 'not-started-btn';
                    notStartedBtn.textContent = 'لم تبدأ بعد';

                    if (isFinished) {
                        watchBtnContainer.appendChild(finishedBtn);
                    } else if (isLive) {
                         watchBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            renderLiveServers(homeTeam, awayTeam);
                            liveServersModal.style.display = 'block';
                        });
                        watchBtnContainer.appendChild(watchBtn);
                    } else if (isNotStartedYet) {
                         watchBtnContainer.appendChild(notStartedBtn);
                    } else {
                         watchBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            renderLiveServers(homeTeam, awayTeam);
                            liveServersModal.style.display = 'block';
                        });
                        watchBtnContainer.appendChild(watchBtn);
                    }
                    
                    channelContainer.appendChild(watchBtnContainer);

                    setTimeout(() => {
                        matchRow.style.opacity = '1';
                    }, 10); 
                    
                    index++;
                    setTimeout(displayNextMatch, 500); 
                }
            }
            displayNextMatch();
        }
        
        displayMatchesGradually(sortedMatches);
    }

    function searchMatches() {
        const query = searchInput.value.toLowerCase().trim();
        const filteredMatches = allMatches.filter(match => {
            const homeTeam = match.querySelector('.team.hometeam .the_team')?.innerText.trim().toLowerCase() || '';
            const awayTeam = match.querySelector('.team.awayteam .the_team')?.innerText.trim().toLowerCase() || '';
            return homeTeam.includes(query) || awayTeam.includes(query);
        });
        renderMatches(filteredMatches);
    }

    refreshBtn.addEventListener('click', () => {
        loadMatches('https://jdwel.com/today/');
    });

    searchInput.addEventListener('input', searchMatches);

    liveServersModalCloseBtn.addEventListener('click', () => {
        liveServersModal.style.display = 'none';
    });
    
    externalPlayerModalCloseBtn.addEventListener('click', () => {
        externalPlayerModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target === liveServersModal) {
            liveServersModal.style.display = 'none';
        }
        if (event.target === externalPlayerModal) {
            externalPlayerModal.style.display = 'none';
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadMatches('https://jdwel.com/today/');
    });
</script>
</body>
</html>
